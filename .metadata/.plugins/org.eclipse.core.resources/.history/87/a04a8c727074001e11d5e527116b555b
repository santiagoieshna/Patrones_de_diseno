package controller;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.stream.Collectors;


import model.Habitacion;
import model.Lado;
import model.Orientacion;

public class Laberinto {
	private HashMap<Coordenada, Habitacion> mapaLaberinto;


	private Coordenada coordenadaOrigen;
	private Coordenada coordenadaFinal;
	private Habitacion habitacion;

	/**
	 * Crear La habitacion Uno en la Coordenada (0, 0) y Orientacion.NORTE
	 */
	public Laberinto() {
		super();
		mapaLaberinto = new HashMap<>();
		this.coordenadaOrigen = new Coordenada(0, 0);
		this.habitacion = new Habitacion(Orientacion.NORTE);
		comenzarLaberinto(9);
	}

	/**
	 * Crear La habitacion Uno en la Coordenada (0, 0)
	 * 
	 * @param habitacion
	 * @param maxHabitaciones
	 */
	public Laberinto(Habitacion habitacion, int maxHabitaciones) {
		super();
		mapaLaberinto = new HashMap<>();
		this.coordenadaOrigen = new Coordenada(0, 0);
		this.habitacion = habitacion;
		comenzarLaberinto(maxHabitaciones);
	}

	public Laberinto(Coordenada cordenadaOrigen, Habitacion habitacion, int maxHabitaciones) {
		super();
		mapaLaberinto = new HashMap<>();
		this.coordenadaOrigen = cordenadaOrigen;
		this.habitacion = habitacion;
		comenzarLaberinto(maxHabitaciones);
	}

	private void comenzarLaberinto(int maxHabitaciones) {
		// Metemos habitacion uno
		mapaLaberinto.put(coordenadaOrigen, habitacion);
		int numeroDeHabitaciones = 2;

		// Coger Orientacion puerta salida
		// Obtener Coordenada
		// Ver vecino
		// hay vecinos?
		// si hay -> prohibir que lado no puede ser puerta
		// Obetener lado contrario -> PuertaEntrada
		// Crear nueva habitacion
		// Meter en el mapa

		// La primer habitacion entra si o si
		Orientacion orientacionPuertaEntrada = habitacion.getPuertaSalida().getOrientacionRelativa();
		Coordenada coordenadaAnterior = coordenadaOrigen;
		Coordenada coordenadaNueva = habitacion.getPuertaSalida().getNuevaCoordenada(coordenadaAnterior);
		Habitacion habitacionNueva= new Habitacion(orientacionPuertaEntrada);
		Orientacion puertaSalida = habitacionNueva.getPuertaSalida();
		mapaLaberinto.put(coordenadaNueva, habitacionNueva);
		
		do{
			// Reseteamos valores
			orientacionPuertaEntrada = habitacionNueva.getPuertaSalida().getOrientacionRelativa();
			// Vemos donde esta la puertaSalida para obener la nueva coorddenada
			puertaSalida = habitacionNueva.getPuertaSalida();
			coordenadaNueva = puertaSalida.getNuevaCoordenada(coordenadaAnterior);
			
			// Ver vecinos
			HashMap<Orientacion, Lado> ladosVecinos = comprobarVecinos(coordenadaNueva, orientacionPuertaEntrada);
			habitacionNueva = new Habitacion(orientacionPuertaEntrada, ladosVecinos);// AQUI FALLA
			mapaLaberinto.put(coordenadaNueva, habitacionNueva);
			coordenadaAnterior = coordenadaNueva;
			
			numeroDeHabitaciones++;
		}while (numeroDeHabitaciones <= maxHabitaciones && habitacionNueva.haySalida()) ;
		setCoordenadaFinal(coordenadaAnterior);
	}


	private HashMap<Orientacion, Lado> comprobarVecinos(Coordenada coordenadaNueva, Orientacion puertaEntrada) {
		HashMap<Orientacion, Lado> ladosOcupados = new HashMap<>();
		List<Orientacion> orientacionesVecinas;
		// List<Coordenada> vecinos = coordenadaNueva.getContiguas();
		
		orientacionesVecinas = Arrays.asList(Orientacion.values()).stream()
				.filter(orientacion -> !orientacion.equals(puertaEntrada))
				.map(orientacion -> orientacion.getOrientacionRelativa()).collect(Collectors.toList());
		
		
		// No habia huevos a pasarlo a mapa por stream() !!!!
		for (Orientacion orientacionVecina : orientacionesVecinas) {
			Coordenada coordenadaVecina = orientacionVecina.getOrientacionRelativa().getNuevaCoordenada(coordenadaNueva);
			if (mapaLaberinto.containsKey(coordenadaVecina)) {
				Lado lado = mapaLaberinto.get(coordenadaVecina).getLado(orientacionVecina);
				ladosOcupados.put(orientacionVecina.getOrientacionRelativa(), lado);
			}
		}
		
		if(ladosOcupados.size()==0) {
			return null;
		}
		
		return ladosOcupados;
	}
	
	private void setCoordenadaFinal(Coordenada coordenadaFinal) {
		this.coordenadaFinal=coordenadaFinal;
	}
	public Coordenada getCoordenadFinal() {
		return this.coordenadaFinal;
	}
	public Coordenada getCoordenadOrigen() {
		return this.coordenadaOrigen;
	}

	public HashMap<Coordenada, Habitacion> getMapaLaberinto() {
		return mapaLaberinto;
	}
}
